<html>
  <head>
    <title>Model Server Front End</title>
    <style>
      * {
        box-sizing: border-box;
        font-family: Verdana,Geneva,sans-serif;
        font-size: 1em;
      }
      html {
        background: #242526;
        color: #18191A;
      }
      .top_bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 100px;
        background-color: white;
        display: flex;
        justify-content: center;
      }
      h1 {
        color: #e4e6eb;
        font-size: 3em;

      }
      .container {
        width: 90%;
        margin: 5% auto;
        border-radius: 5px;
        background: #e4e6eb;
        border: 1px solid #666;
        padding: 5%;
        display: table;
        content: "";
        clear: both;
      }
      input[type="submit"][disabled]:hover {
        background: #B0B3B8;
      }
      input[type="submit"]:not([disabled]){
        background:green;
      }
      input[type="submit"] {
        background: #B0B3B8;
        width: 200px;
        height: 50px;
        font-size: 1.5em;
        border: solid 1px transparent;
        border-radius: 15px;
        color: #fff;
      }
      input[type="submit"]:hover {
        background: #3A3B3C;
        color: white;
        cursor: pointer;
      }

    </style>
  </head>
  <body >
    <div class="top_bar"> <h1>Model Server Front End</h1> </div>
    <div class="container">
      <div style="float: left; width: 50%">
        <form id="msfe">
          <div style="margin: 15px 0">
            <h2>Preview</h2>
            <p><i>File size: <span id="fileSize"></span></i></span></p>
            <p><i>File type: <span id="fileType"></span></i></span></p>
            <img id="preview" style="background-color: #ccc; border: 1px solid #666; width: 200px; height: 150px; border-radius: 5px;" />
          </div>
          <label style="margin: 15px 0">
            <span hidden>File Upload:</span>
            <input type="file" name="file" id="file_upload" />
            <!-- <input type="hidden" name="type" value="image/jpg" /> -->
          </label>
          <div id="hiddenError" style="color: red;" hidden></div>
          <input type="submit" id="submit" value="Submit" style="margin: 15px 0" disabled>
        </form>
        <!-- <form id="restrictions">
          <h2>File type validation</h2>
          <label>Validate file before upload? <input type="checkbox" id="validate_bool" name="validate_bool"></label>
          <label>File size: <input type="text" id="fileSize_spec" name="fileSize_spec"></label>
          <label>File type: <input type="text" id="fileType_spec" name="fileType_spec"></label>
        </form> -->
      </div>
      <div style="float: left; width: 50%">
        <h2>Results</h2>
        <div>
          <div id="success">Success: N/A</div>
          <h3>Predictions</h3>
          <div id="predictions">N/A</div>
        </div>
      </div>
    </div>





    <script type="text/javascript">
      const form = document.getElementById("msfe");
      const submitButton = document.getElementById("submit");
      const fileInput = document.getElementById("file_upload");
      const hiddenError = document.getElementById("hiddenError");
      const previewImg = document.getElementById("preview");

      const successEl = document.getElementById("success");
      const predictionsEl = document.getElementById("predictions");;

      const validateAndSubmit = (e) => {
        e.preventDefault();
        const file = fileInput.files[0];
        const validation = validateFile(file);
        hiddenError.innerHTML = `${validation.message}`;

        if( validation.ok ){
          return postFile();
        }
      }

      const preview = (file) => {
        if(file){
          document.getElementById("fileSize").innerHTML = file.size;
          document.getElementById("fileType").innerHTML = file.type;
          previewImg.src = URL.createObjectURL( file );
        } else {
          previewImg.src = "";
        }

      }

      const validateFile = (file) => {
        if(file){
          submitButton.disabled = false;
          return {ok: true, message: ""};
        } else {
          submitButton.disabled = true;
          return {ok: false, message: "Error with file"};
        }

      }

      const postFile = () => {
         var myHeaders = new Headers();
         myHeaders.append("Accept", "*/*");
         myHeaders.append("Connection", "keep-alive");
         myHeaders.append("Host", "http://ocalhost/");

         /* Do NOT send content-type */
         // myHeaders.append("Content-Type", 'multipart/form-data;boundary=""');


        //  const fakeData = {
        //     "success": true,
        //     "predictions": [
        //         {
        //             "category_id": "Eel",
        //             "scores": [
        //                 "0.0",
        //                 "0.9676675"
        //             ],
        //             "bbox": "[273.6246643066406, 0.0, 446.3753356933594, 1.0]"
        //         }
        //     ]
        // };

        // return handleData(fakeData);

         var formdata = new FormData();
         formdata.append("file", fileInput.files[0]);

         var requestOptions = {
           method: 'POST',
           headers: myHeaders,
           body: formdata,
           redirect: 'follow'
         };

         fetch("http://localhost:8082/predictor/", requestOptions)
         .then(response => response.json())
         .then(data => {
           console.log(data);
           return handleData(data);
         })
         .catch(error => console.log('error', error));
      }

      const handleData = (data) => {
        if(data.success !== null){
          successEl.innerHTML = `Success: ${data.success}`;
        }
        if(data.predictions !== null){
          predictionsEl.innerHTML = "";
          for(let prediction of data.predictions){
            let predictionNode = document.createElement("div");
            let categoryId = document.createElement("p");
            let scores = document.createElement("p");
            let bbox = document.createElement("p");

            if(prediction.category_id !== null){
              categoryId.textContent = `Category ID: ${prediction.category_id}`;
              predictionNode.appendChild(categoryId);
            }

            if(prediction.scores !== null){
              scores.innerHTML = "Scores: <br/>"
              for(let score of prediction.scores){
                scores.innerHTML += `${score} <br/>`;
              }
              predictionNode.appendChild(scores);
            }

            if(prediction.bbox !== null){
              bbox.textContent = `Bounding Box: ${prediction.bbox}`;
              predictionNode.appendChild(bbox);
            }

            predictionsEl.appendChild( predictionNode );
          }
        } else {
          predictionsEl.innerHTML = "N/A";
        }
      }

      const validateAndPreview = ()=>{
        const file = fileInput.files[0];
        validateFile(file);
        preview(file);
      }

      // Page listeners
      form.addEventListener("submit", validateAndSubmit);
      fileInput.addEventListener("change", validateAndPreview);
    </script>
  </body>
</html>
